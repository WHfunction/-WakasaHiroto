<script>
document.addEventListener("DOMContentLoaded", () => {
    // --- グローバル変数 & データ定義 ---
    let studyData = JSON.parse(localStorage.getItem('studyData')) || { goal: 0, logs: [] };
    let calendarEvents = JSON.parse(localStorage.getItem('calendarEvents')) || [];
    let expenseData = JSON.parse(localStorage.getItem('expenseData')) || [];
    let notepadData = JSON.parse(localStorage.getItem('notepadData')) || [];
    let countdownData = JSON.parse(localStorage.getItem('countdownData')) || [];
    let userAddedSites = JSON.parse(localStorage.getItem('userAddedSites')) || {};
    let activeNoteId = null;
    let currentDate = new Date();
    let selectedDate = null;
    let editingEventId = null;

    const eventCategories = { 'c1': { name: '合唱・声楽', color: 'var(--cat-c1)' }, 'c2': { name: '研究', color: 'var(--cat-c2)' }, 'c3': { name: '家庭', color: 'var(--cat-c3)' }, 'c4': { name: 'ソルフェージュ・ピアノ', color: 'var(--cat-c4)' }, 'c5': { name: '学校', color: 'var(--cat-c5)' }, 'c6': { name: '申込締切・開始', color: 'var(--cat-c6)' }, 'c7': { name: '1on1', color: 'var(--cat-c7)' }, 'c8': { name: '病院', color: 'var(--cat-c8)' }, 'c9': { name: 'その他', color: 'var(--cat-c9)' } };
    const expenseItemDefinitions = { food: { name: '食料品', items: { ice_cream: { name: 'スーパーカップ・爽', logic: 'store_select', stores: { '187': 'コンビニ (187円)', '116': 'ラ・ムー (116円)', '150': 'ハピータウン (150円)' } }, giant_cone: { name: 'ジャイアントコーン', logic: 'store_select', stores: { '213': 'コンビニ (213円)', '130': 'ラ・ムー (130円)', '150': 'ハピータウン (150円)' } }, melon_pan: { name: 'メロンパン(149円)', logic: 'fixed_price', price: 149 }, ika_fry: { name: 'イカフライ', logic: 'price_input' }, seven_potato: { name: 'セブンポテト(150円)', logic: 'fixed_price', price: 150 }, }}, hobby: { name: '趣味', items: { ticket: { name: '切符', logic: 'price_input' } } }, program: { name: 'プログラム', items: { book: { name: '本', logic: 'price_input' } } }, other: { name: 'その他', items: { other: { name: 'その他', logic: 'other_input' } } } };
    const escapeHTML = str => str ? str.toString().replace(/[&<>"']/g, match => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'})[match]) : '';

    // --- 初期化 ---
    function init() {
        updateClock();
        setInterval(updateClock, 1000);
        updateGmailNotification();
        setInterval(updateGmailNotification, 60000);
        updateAllSubmissionNotifications();
        
        setupHeaderClick();
        setupNavigation();
        setupDashboard();
        setupStudyTracker();
        setupCalendar();
        setupExpenseTracker();
        setupNotepad();
        setupCountdown();
        setupGmail();
        
        updateHeaderStats();
    }

    // --- 共通・ヘッダー機能 ---
    function updateClock() { const now = new Date(); const days = ["日", "月", "火", "水", "木", "金", "土"]; document.getElementById('clock-date').textContent = `${now.getFullYear()}年${now.getMonth() + 1}月${now.getDate()}日 (${days[now.getDay()]})`; document.getElementById('clock-time').textContent = now.toLocaleTimeString('ja-JP'); }
    function setupNavigation() { const mainContainers = document.querySelectorAll('main'); const navButtons = document.querySelectorAll('.nav-button'); navButtons.forEach(button => { button.addEventListener('click', (e) => { navButtons.forEach(btn => btn.classList.remove('active')); e.currentTarget.classList.add('active'); const targetId = e.currentTarget.id.replace('nav-', '') + '-container'; mainContainers.forEach(container => container.classList.toggle('active', container.id === targetId)); if (targetId === 'gmail-container' && document.getElementById('gmail-list').children.length === 0) { loadGmailMessages(); } if (targetId === 'notepad-container') { activeNoteId = null; renderNoteList(); renderEditor(); } }); }); }
    function setupHeaderClick() { const headerTitle = document.getElementById('header-title'); if (headerTitle) { headerTitle.addEventListener('click', () => { const dashboardButton = document.getElementById('nav-dashboard'); if (dashboardButton) { dashboardButton.click(); } }); } }
    function updateHeaderStats() {
        const statsEl = document.getElementById('header-stats');
        const studyTotalEl = document.getElementById('header-study-total');
        const expenseTotalEl = document.getElementById('header-expense-total');
        if (!statsEl || !studyTotalEl || !expenseTotalEl) return;
        const now = new Date();
        const currentMonthStr = now.getFullYear() + '-' + ('0' + (now.getMonth() + 1)).slice(-2);
        const totalMinutes = studyData.logs.filter(log => log.date && log.date.startsWith(currentMonthStr)).reduce((sum, log) => sum + (log.minutes || 0), 0);
        const totalHours = (totalMinutes / 60).toFixed(1);
        const totalExpense = expenseData.filter(item => { if (!item.date) return false; const itemDate = new Date(item.date); return itemDate.getFullYear() === now.getFullYear() && itemDate.getMonth() === now.getMonth(); }).reduce((sum, item) => sum + (item.price || 0), 0);
        studyTotalEl.innerHTML = `今月の勉強: <span class="value">${totalHours} h</span>`;
        expenseTotalEl.innerHTML = `今月の出費: <span class="value">${totalExpense.toLocaleString()} 円</span>`;
        statsEl.classList.remove('is-hidden');
    }

    // --- ダッシュボード機能 ---
    function setupDashboard() { renderLinks(); document.getElementById('add-site-form').addEventListener('submit', addSite); document.getElementById('clear-added-sites').addEventListener('click', clearAddedSites); document.getElementById('local-app-search-input').addEventListener('input', handleLocalAppSearch); }
    function renderLinks() { const defaultLinks = { "sns-links": [{name:"X",url:"https://twitter.com/"}, {name:"Facebook",url:"https://www.facebook.com/"}, {name:"Outlook",url:"https://outlook.live.com/"}, {name:"Gメール",url:"https://mail.google.com/"}], "ai-links": [{name:"Grok",url:"https://x.com/i/grok"},{name:"ChatGPT",url:"https://chat.openai.com/"}, {name:"Gemini",url:"https://gemini.google.com/"}], "programming-links": [{name:"CodePen",url:"https://codepen.io/"}, {name:"ChatGPT",url:"https://chat.openai.com/"}, {name:"Gemini",url:"https://gemini.google.com/"}], "research-links": [{name:"CodePen",url:"https://codepen.io/"}, {name:"ChatGPT",url:"https://chat.openai.com/"}, {name:"Gemini",url:"https://gemini.google.com/"}, {name:"Word",url:"https://www.office.com/launch/word"}, {name:"Powerpoint",url:"https://www.office.com/launch/powerpoint"}, {name:"Excel",url:"https://www.office.com/launch/excel"}, {name:"Outlook",url:"https://outlook.live.com/"}], "study-links": [{name:"TryIT",url:"https://student.try-it.jp/home"}, {name:"Studyplus",url:"https://app.studyplus.jp/report"}, {name:"マナビジョン",url:"https://manabi.benesse.ne.jp/member/index.html"}], "school-links": [{name:"Classroom",url:"https://classroom.google.com/"}, {name:"ドライブ",url:"https://drive.google.com/"}, {name:"ドキュメント",url:"https://docs.google.com/"}, {name:"スライド",url:"https://slides.google.com/"}, {name:"スプレッドシート",url:"https://sheets.google.com/"}, {name:"Gメール",url:"https://mail.google.com/"}, {name:"カレンダー",url:"https://calendar.google.com/"}], "timetable-links": [{name:"西川原駅(山陽)",url:"https://ekitan.com/timetable/railway/line-station/115-121/d1"}, {name:"岡山駅(山陽)",url:"https://ekitan.com/timetable/railway/line-station/115-35/d1"}, {name:"岡山駅(津山)",url:"https://ekitan.com/timetable/railway/line-station/144-16/d1"}, {name:"法界院駅(津山)",url:"https://ekitan.com/timetable/railway/line-station/144-15/d2"}, {name:"西大寺駅(赤穂)",url:"https://ekitan.com/timetable/railway/line-station/1-16/d2"}, {name:"植物園口(表町)",url:"https://www.unobus.co.jp/bustei/322.html#322_05"}, {name:"中央警察署前(表町)",url:"https://www.unobus.co.jp/bustei/672.html#672_05"}, {name:"岡山駅(三野)",url:"https://www.unobus.co.jp/bustei/2.html#2_04"}, {name:"岡山駅(東岡山)",url:"https://www.unobus.co.jp/bustei/2.html#2_11"}], "geo-links": [{name:"Googleマップ",url:"https://www.google.co.jp/maps/@34.6771087,133.9410877,14.37z"}, {name:"乗りつぶし",url:"https://www.noritsubushi.org/"}, {name:"駅スパート",url:"https://roote.ekispert.net/rmap"}, {name:"駅探",url:"https://ekitan.com/"}, {name:"Yahoo乗換",url:"https://transit.yahoo.co.jp/"}, {name:"JR西 運行情報",url:"https://trafficinfo.westjr.co.jp/chugoku.html"}], "music-links": [], "saionji-links": [] }; const allLinks = {}; for(const key in defaultLinks){ allLinks[key] = [...defaultLinks[key]]; } for(const key in userAddedSites){ if(allLinks[key]){ allLinks[key].push(...userAddedSites[key]); } else { allLinks[key] = [...userAddedSites[key]]; } } Object.keys(allLinks).forEach(id => { const container = document.getElementById(id); if (container) { container.innerHTML = ''; allLinks[id].forEach((link) => { const linkCard = document.createElement('a'); linkCard.href = link.url; linkCard.textContent = link.name; linkCard.className = 'link-card'; linkCard.target = '_blank'; if (userAddedSites[id] && userAddedSites[id].some(userLink => userLink.name === link.name && userLink.url === link.url)) { const removeBtn = document.createElement('div'); removeBtn.className = 'remove-button'; removeBtn.innerHTML = '&times;'; removeBtn.onclick = (e) => { e.preventDefault(); e.stopPropagation(); removeSite(id, link.name, link.url); }; linkCard.appendChild(removeBtn); } container.appendChild(linkCard); }); } }); const siteCategorySelect = document.getElementById('site-category'); if (siteCategorySelect) { siteCategorySelect.innerHTML = Object.keys(defaultLinks).map(id => `<option value="${id}">${id.replace('-links', '')}</option>`).join(''); } }
    function addSite(e) { e.preventDefault(); const name = document.getElementById('site-name').value; const url = document.getElementById('site-url').value; const category = document.getElementById('site-category').value; if (!userAddedSites[category]) { userAddedSites[category] = []; } userAddedSites[category].push({ name, url }); localStorage.setItem('userAddedSites', JSON.stringify(userAddedSites)); renderLinks(); e.target.reset(); }
    function removeSite(category, name, url) { if(userAddedSites[category]){ userAddedSites[category] = userAddedSites[category].filter(link => link.name !== name || link.url !== url); if(userAddedSites[category].length === 0){ delete userAddedSites[category]; } localStorage.setItem('userAddedSites', JSON.stringify(userAddedSites)); renderLinks(); } }
    function clearAddedSites() { if (confirm('追加したすべてのサイトを削除しますか？')) { userAddedSites = {}; localStorage.removeItem('userAddedSites'); renderLinks(); } }
    function handleLocalAppSearch(e) { const searchTerm = e.target.value.toLowerCase().trim(); document.querySelectorAll('#dashboard-container .link-card').forEach(link => { const isVisible = link.textContent.toLowerCase().includes(searchTerm); link.classList.toggle('is-hidden', !isVisible); }); document.querySelectorAll('#dashboard-container .filterable-widget').forEach(widget => { const visibleLinks = widget.querySelectorAll('.link-card:not(.is-hidden)'); widget.classList.toggle('is-hidden', visibleLinks.length === 0); if (searchTerm && visibleLinks.length > 0) { widget.querySelector('details').open = true; } }); }

    // --- 勉強管理機能 ---
    function setupStudyTracker() {
        const subjectSelect = document.getElementById('study-subject');
        // ▼▼▼ 教科リストを更新 ▼▼▼
        const subjects = [
            '数学1', '数学A', '現代国語', '古文', '漢文', '漢字', '英語', 
            '英単語', '物理基礎', '生物基礎', '化学基礎', '歴史総合', '地理総合', '公共'
        ];
        subjectSelect.innerHTML = subjects.map(s => `<option value="${s}">${s}</option>`).join('');
        
        const setDateToToday = () => document.getElementById('study-date').value = new Date().toISOString().split('T')[0];
        document.getElementById('goal-form').addEventListener('submit', (e) => { e.preventDefault(); studyData.goal = parseFloat(document.getElementById('monthly-goal').value) || 0; localStorage.setItem('studyData', JSON.stringify(studyData)); renderStudyProgress(); });
        document.getElementById('add-study-log-form').addEventListener('submit', (e) => { e.preventDefault(); const log = { id: Date.now(), date: document.getElementById('study-date').value, subject: document.getElementById('study-subject').value, minutes: parseInt(document.getElementById('study-minutes').value) }; studyData.logs.push(log); localStorage.setItem('studyData', JSON.stringify(studyData)); renderAllStudy(); updateHeaderStats(); e.target.reset(); setDateToToday(); });
        setDateToToday();
        renderAllStudy();
    }
    function renderAllStudy() { renderStudyProgress(); renderStudyLogList(); renderWeeklyChart(); renderSubjectTotals(); }
    function renderStudyProgress() { document.getElementById('monthly-goal').value = studyData.goal; const now = new Date(); const currentMonthStr = now.getFullYear() + '-' + ('0' + (now.getMonth() + 1)).slice(-2); const totalMinutes = studyData.logs.filter(log => log.date && log.date.startsWith(currentMonthStr)).reduce((sum, log) => sum + log.minutes, 0); const totalHours = totalMinutes / 60; const remainingHours = studyData.goal - totalHours; const progress = studyData.goal > 0 ? (totalHours / studyData.goal) * 100 : 0; document.getElementById('goal-hours-display').textContent = studyData.goal; document.getElementById('current-hours-display').textContent = totalHours.toFixed(1); document.getElementById('remaining-hours-display').textContent = remainingHours.toFixed(1); document.getElementById('progress-text').textContent = `${Math.min(100, Math.round(progress))}%`; const progressBar = document.getElementById('progress-bar'); const circumference = 408.4; const offset = circumference - (Math.min(100, progress) / 100) * circumference; progressBar.style.strokeDashoffset = offset; }
    function renderStudyLogList() { const list = document.getElementById('study-log-list'); const todayStr = new Date().toISOString().split('T')[0]; list.innerHTML = ''; studyData.logs.filter(l => l.date === todayStr).forEach(log => { const li = document.createElement('li'); li.innerHTML = `<span>${escapeHTML(log.subject)}</span><span>${log.minutes} 分</span><button class="event-remove-btn" data-id="${log.id}">&times;</button>`; list.appendChild(li); }); list.querySelectorAll('.event-remove-btn').forEach(btn => btn.addEventListener('click', (e) => { studyData.logs = studyData.logs.filter(l => l.id !== parseInt(e.target.dataset.id)); localStorage.setItem('studyData', JSON.stringify(studyData)); renderAllStudy(); updateHeaderStats(); })); }
    function renderWeeklyChart() { const container = document.getElementById('weekly-chart-container'); const yAxis = document.getElementById('weekly-chart-y-axis'); container.innerHTML = ''; yAxis.innerHTML = ''; const today = new Date(); const weeklyData = Array(7).fill(0); for (let i = 0; i < 7; i++) { const date = new Date(today); date.setDate(today.getDate() - i); const dateStr = date.toISOString().split('T')[0]; weeklyData[6 - i] = studyData.logs.filter(log => log.date === dateStr).reduce((sum, log) => sum + log.minutes, 0); } const maxMinutes = Math.max(60, ...weeklyData); for (let i = 4; i >= 0; i--) { yAxis.innerHTML += `<div>${(maxMinutes / 4 * i / 60).toFixed(1)}h</div>`; } const days = ['日', '月', '火', '水', '木', '金', '土']; weeklyData.forEach((minutes, i) => { const dayIndex = (today.getDay() - (6 - i) + 7) % 7; const height = maxMinutes > 0 ? (minutes / maxMinutes) * 100 : 0; container.innerHTML += `<div class="bar-wrapper"><div class="bar" style="height: ${height}%"></div><div class="bar-label">${days[dayIndex]}</div></div>`; }); }
    function renderSubjectTotals() { const list = document.getElementById('subject-totals-list'); list.innerHTML = ''; const subjectMap = new Map(); const now = new Date(); const currentMonthStr = now.getFullYear() + '-' + ('0' + (now.getMonth() + 1)).slice(-2); studyData.logs.filter(log => log.date.startsWith(currentMonthStr)).forEach(log => { subjectMap.set(log.subject, (subjectMap.get(log.subject) || 0) + log.minutes); }); list.innerHTML = ''; Array.from(subjectMap.entries()).forEach(([subject, minutes]) => { list.innerHTML += `<li><span class="subject-name">${escapeHTML(subject)}</span><span class="subject-time">${(minutes / 60).toFixed(1)} h</span></li>`; });}

    // --- カレンダー機能 ---
    function setupCalendar() { document.getElementById('prev-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() - 1); renderCalendar(); }); document.getElementById('next-month').addEventListener('click', () => { currentDate.setMonth(currentDate.getMonth() + 1); renderCalendar(); }); document.getElementById('today-btn').addEventListener('click', () => { currentDate = new Date(); renderCalendar(); }); const form = document.getElementById('add-event-form'); form.addEventListener('submit', (e) => { e.preventDefault(); if (!selectedDate) { alert('日付を選択してください。'); return; } const dateStr = selectedDate.toISOString().split('T')[0]; const newEvent = { id: editingEventId || Date.now().toString(), title: document.getElementById('event-title').value, category: document.getElementById('event-category').value, date: dateStr, startTime: document.getElementById('event-start-time').value, endTime: document.getElementById('event-end-time').value }; if (editingEventId) { calendarEvents = calendarEvents.map(ev => ev.id === editingEventId ? newEvent : ev); } else { calendarEvents.push(newEvent); } localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents)); renderCalendar(); renderEventList(selectedDate); form.reset(); editingEventId = null; document.getElementById('event-submit-btn').textContent = "予定を追加"; document.getElementById('event-cancel-btn').style.display = 'none'; }); document.getElementById('event-cancel-btn').addEventListener('click', () => { editingEventId = null; form.reset(); document.getElementById('event-submit-btn').textContent = "予定を追加"; document.getElementById('event-cancel-btn').style.display = 'none'; }); const categorySelect = document.getElementById('event-category'); categorySelect.innerHTML = ''; for (const key in eventCategories) { categorySelect.innerHTML += `<option value="${key}">${eventCategories[key].name}</option>`; } renderCalendar(); }
    function renderCalendar() { const year = currentDate.getFullYear(); const month = currentDate.getMonth(); document.getElementById('calendar-month-year').textContent = `${year}年 ${month + 1}月`; const grid = document.getElementById('calendar-dates-grid'); grid.innerHTML = ''; const firstDay = new Date(year, month, 1).getDay(); const daysInMonth = new Date(year, month + 1, 0).getDate(); for (let i = 0; i < firstDay; i++) { grid.innerHTML += `<div class="date-cell other-month"></div>`; } for (let i = 1; i <= daysInMonth; i++) { const date = new Date(year, month, i); const dateStr = date.toISOString().split('T')[0]; const cell = document.createElement('div'); cell.className = 'date-cell'; const eventsForDay = calendarEvents.filter(e => e.date === dateStr).sort((a,b) => (a.startTime || '').localeCompare(b.startTime || '')); let eventBandsHTML = ''; eventsForDay.forEach(event => { eventBandsHTML += `<div class="event-band" style="background-color:${eventCategories[event.category]?.color || '#e0e0e0'}">${escapeHTML(event.title)}</div>`; }); cell.innerHTML = `<div class="date-number">${i}</div><div class="event-bands">${eventBandsHTML}</div>`; if (date.toDateString() === new Date().toDateString()) cell.classList.add('today'); if (selectedDate && date.toDateString() === selectedDate.toDateString()) cell.classList.add('selected'); cell.addEventListener('click', () => { selectedDate = date; grid.querySelectorAll('.selected').forEach(c => c.classList.remove('selected')); cell.classList.add('selected'); renderEventList(date); }); grid.appendChild(cell); } }
    function renderEventList(date) { document.getElementById('selected-date-display').textContent = `${date.getMonth() + 1}月${date.getDate()}日の予定`; const list = document.getElementById('event-list'); list.innerHTML = ''; const dateStr = date.toISOString().split('T')[0]; calendarEvents.filter(e => e.date === dateStr).sort((a,b) => (a.startTime || '').localeCompare(b.startTime || '')).forEach(event => { const li = document.createElement('li'); li.innerHTML = `<div class="event-color-dot" style="background-color: ${eventCategories[event.category]?.color || '#e0e0e0'}"></div><div class="event-details"><div class="event-title">${escapeHTML(event.title)}</div><div class="event-time">${event.startTime || ''} - ${event.endTime || ''}</div></div><button class="event-remove-btn" data-id="${event.id}">&times;</button>`; list.appendChild(li); }); list.querySelectorAll('.event-remove-btn').forEach(btn => { btn.addEventListener('click', (e) => { e.stopPropagation(); const eventId = e.target.dataset.id; calendarEvents = calendarEvents.filter(ev => ev.id !== eventId); localStorage.setItem('calendarEvents', JSON.stringify(calendarEvents)); renderCalendar(); renderEventList(selectedDate); }); }); }

    // --- 出費管理機能 ---
    function setupExpenseTracker() { const form = document.getElementById('add-expense-form'); const itemSelect = document.getElementById('expense-item-select'); const detailsContainer = document.getElementById('expense-details-container'); itemSelect.innerHTML = ''; Object.keys(expenseItemDefinitions).forEach(groupKey => { const optgroup = document.createElement('optgroup'); optgroup.label = expenseItemDefinitions[groupKey].name; Object.keys(expenseItemDefinitions[groupKey].items).forEach(itemKey => { optgroup.innerHTML += `<option value="${groupKey}.${itemKey}">${expenseItemDefinitions[groupKey].items[itemKey].name}</option>`; }); itemSelect.appendChild(optgroup); }); const renderDetails = () => { detailsContainer.innerHTML = ''; const [groupKey, itemKey] = itemSelect.value.split('.'); const itemDef = expenseItemDefinitions[groupKey].items[itemKey]; if (itemDef.logic === 'store_select') { let options = ''; Object.keys(itemDef.stores).forEach(price => options += `<option value="${price}">${itemDef.stores[price]}</option>`); detailsContainer.innerHTML = `<div class="form-group"><label>店舗</label><select class="form-group">${options}</select></div>`; } else if (itemDef.logic === 'price_input' || itemDef.logic === 'other_input') { detailsContainer.innerHTML = `<div class="form-group"><label>金額</label><input type="number" class="form-group" placeholder="金額を入力" required></div>`; } }; itemSelect.addEventListener('change', renderDetails); form.addEventListener('submit', (e) => { e.preventDefault(); const [groupKey, itemKey] = itemSelect.value.split('.'); const itemDef = expenseItemDefinitions[groupKey].items[itemKey]; let price = 0; if (itemDef.logic === 'fixed_price') price = itemDef.price; else price = parseInt(detailsContainer.querySelector('input, select')?.value || 0); if (!price) return; const newExpense = { id: Date.now(), name: itemDef.name, group: expenseItemDefinitions[groupKey].name, price: price, date: new Date().toISOString() }; expenseData.push(newExpense); localStorage.setItem('expenseData', JSON.stringify(expenseData)); renderAllExpense(); updateHeaderStats(); renderDetails(); }); renderAllExpense(); renderDetails(); }
    function renderAllExpense() { renderExpenseLog(); renderExpenseTotal(); renderExpenseGroupTotals(); }
    function renderExpenseLog() { const list = document.getElementById('expense-log-list'); const now = new Date(); list.innerHTML = ''; expenseData.filter(item => new Date(item.date).getMonth() === now.getMonth()).forEach(item => { const li = document.createElement('li'); li.innerHTML = `<span>${escapeHTML(item.name)}</span><span>${item.price.toLocaleString()} 円</span><button class="event-remove-btn" data-id="${item.id}">&times;</button>`; list.appendChild(li); }); list.querySelectorAll('.event-remove-btn').forEach(btn => btn.addEventListener('click', (e) => { expenseData = expenseData.filter(i => i.id !== parseInt(e.target.dataset.id)); localStorage.setItem('expenseData', JSON.stringify(expenseData)); renderAllExpense(); updateHeaderStats(); })); }
    function renderExpenseTotal() { const now = new Date(); const total = expenseData.filter(item => new Date(item.date).getMonth() === now.getMonth()).reduce((sum, item) => sum + item.price, 0); document.getElementById('expense-total-display').textContent = `${total.toLocaleString()}円`; }
    function renderExpenseGroupTotals() { const list = document.getElementById('expense-group-totals-list'); list.innerHTML = ''; const groupMap = new Map(); const now = new Date(); expenseData.filter(item => item.date && new Date(item.date).getMonth() === now.getMonth()).forEach(item => { groupMap.set(item.group, (groupMap.get(item.group) || 0) + item.price); }); list.innerHTML = ''; Array.from(groupMap.entries()).forEach(([group, price]) => list.innerHTML += `<li><span>${escapeHTML(group)}</span><span>${price.toLocaleString()} 円</span></li>`); }

    // --- メモ帳機能 ---
    function setupNotepad() { document.getElementById('add-note-btn').addEventListener('click', () => { const newNote = { id: Date.now().toString(), title: "新しいメモ", body: "" }; notepadData.unshift(newNote); localStorage.setItem('notepadData', JSON.stringify(notepadData)); activeNoteId = newNote.id; renderNoteList(); renderEditor(); }); document.getElementById('note-title-input').addEventListener('input', (e) => saveNote(activeNoteId, { title: e.target.value })); document.getElementById('note-body-textarea').addEventListener('input', (e) => saveNote(activeNoteId, { body: e.target.value })); document.getElementById('delete-note-btn').addEventListener('click', () => { if (!confirm('このメモを削除しますか？')) return; notepadData = notepadData.filter(note => note.id !== activeNoteId); localStorage.setItem('notepadData', JSON.stringify(notepadData)); activeNoteId = null; renderNoteList(); renderEditor(); }); renderNoteList(); renderEditor(); }
    function renderNoteList() { const list = document.getElementById('note-list'); list.innerHTML = ''; notepadData.forEach(note => { const li = document.createElement('li'); li.className = note.id === activeNoteId ? 'active' : ''; li.dataset.id = note.id; li.innerHTML = `<span class="note-title">${escapeHTML(note.title) || '無題のメモ'}</span><span class="note-preview">${escapeHTML(note.body.substring(0, 20))}...</span>`; li.addEventListener('click', () => { activeNoteId = note.id; renderNoteList(); renderEditor(); }); list.appendChild(li); }); }
    function renderEditor() { const editor = document.getElementById('notepad-editor'); const welcome = document.getElementById('notepad-welcome'); const note = notepadData.find(n => n.id === activeNoteId); if (note) { editor.classList.remove('hidden'); welcome.classList.add('hidden'); document.getElementById('note-title-input').value = note.title; document.getElementById('note-body-textarea').value = note.body; } else { editor.classList.add('hidden'); welcome.classList.remove('hidden'); } }
    function saveNote(id, data) { if (!id) return; const noteIndex = notepadData.findIndex(note => note.id === id); if (noteIndex > -1) { notepadData[noteIndex] = { ...notepadData[noteIndex], ...data }; localStorage.setItem('notepadData', JSON.stringify(notepadData)); const activeLi = document.querySelector(`#note-list li[data-id="${id}"]`); if (activeLi) { activeLi.querySelector('.note-title').textContent = data.title || notepadData[noteIndex].title || '無題のメモ'; activeLi.querySelector('.note-preview').textContent = `${(data.body || notepadData[noteIndex].body).substring(0, 20)}...`; } } }

    // --- カウントダウン機能 ---
    function setupCountdown() { const form = document.getElementById('add-countdown-form'); if (form) { form.addEventListener('submit', (e) => { e.preventDefault(); const titleInput = document.getElementById('countdown-title-input'); const dateInput = document.getElementById('countdown-date-input'); if (titleInput.value && dateInput.value) { const newItem = { id: Date.now().toString(), title: titleInput.value, date: dateInput.value }; countdownData.push(newItem); localStorage.setItem('countdownData', JSON.stringify(countdownData)); renderCountdownList(); form.reset(); } }); } renderCountdownList(); }
    function renderCountdownList() { const list = document.getElementById('countdown-list'); const headerCountdownEl = document.getElementById('header-countdown'); if (!list || !headerCountdownEl) return; list.innerHTML = ''; if (countdownData.length === 0) { list.innerHTML = '<li>追加されたカウントダウンはありません。</li>'; headerCountdownEl.classList.add('is-hidden'); return; } const today = new Date(); today.setHours(0, 0, 0, 0); const sortedData = [...countdownData].sort((a, b) => new Date(a.date) - new Date(b.date)); const futureData = sortedData.filter(item => (new Date(item.date).getTime() - today.getTime()) >= 0); if (futureData.length > 0) { const soonestCountdown = futureData[0]; const targetDate = new Date(soonestCountdown.date); const diffTime = targetDate.getTime() - today.getTime(); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); headerCountdownEl.innerHTML = `<div class="title">${escapeHTML(soonestCountdown.title)} まで</div><div class="days">あと ${diffDays} 日</div>`; headerCountdownEl.classList.remove('is-hidden'); } else { headerCountdownEl.classList.add('is-hidden'); } sortedData.forEach(item => { const targetDate = new Date(item.date); const diffTime = targetDate.getTime() - today.getTime(); const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); const li = document.createElement('li'); if (futureData.length > 0 && item.id === futureData[0].id) { li.classList.add('is-header-countdown'); } li.innerHTML = `<div class="countdown-info"><div class="countdown-title">${escapeHTML(item.title)}</div><div class="countdown-date">${escapeHTML(item.date)}</div></div><div class="countdown-remaining">${diffDays >= 0 ? `あと ${diffDays} 日` : '終了'}</div><button class="event-remove-btn" data-id="${item.id}">×</button>`; list.appendChild(li); }); list.querySelectorAll('.event-remove-btn').forEach(btn => { btn.addEventListener('click', (e) => { const idToRemove = e.target.getAttribute('data-id'); countdownData = countdownData.filter(item => item.id !== idToRemove); localStorage.setItem('countdownData', JSON.stringify(countdownData)); renderCountdownList(); }); }); }

    // --- Gmail & Calendar 通知機能 ---
    function setupGmail() { document.getElementById('refresh-gmail-btn').addEventListener('click', loadGmailMessages); }
    function updateGmailNotification() { google.script.run.withSuccessHandler(count => { const notification = document.getElementById('gmail-notification'); if (count > 0) { notification.textContent = `新着メール ${count}件`; notification.classList.remove('is-hidden'); } else { notification.classList.add('is-hidden'); } }).getUnreadMailCount(); }
    function updateAllSubmissionNotifications() { google.script.run.withSuccessHandler(status => { const todayNotification = document.getElementById('submission-notification'); const tomorrowNotification = document.getElementById('tomorrow-submission-notification'); if (status.today) { todayNotification.textContent = '本日提出物あり'; todayNotification.classList.remove('is-hidden'); } else { todayNotification.classList.add('is-hidden'); } if (status.tomorrow) { tomorrowNotification.textContent = '明日提出物あり'; tomorrowNotification.classList.remove('is-hidden'); } else { tomorrowNotification.classList.add('is-hidden'); } }).getSubmissionStatus(); }
    function loadGmailMessages() { const list = document.getElementById('gmail-list'); const loading = document.getElementById('gmail-loading'); list.innerHTML = ''; loading.style.display = 'block'; google.script.run.withSuccessHandler(displayGmailMessages).withFailureHandler(displayGmailError).getGmailMessages(); }
    function displayGmailMessages(data) { const list = document.getElementById('gmail-list'); const loading = document.getElementById('gmail-loading'); loading.style.display = 'none'; updateGmailNotification(); if (data.error) { displayGmailError({ message: data.error }); return; } if (!data || data.length === 0) { list.innerHTML = '<li>受信トレイにメールはありません。</li>'; return; } data.forEach(email => { const li = document.createElement('li'); if (email.isUnread) { li.classList.add('unread'); } li.innerHTML = `<div class="gmail-header"><span class="gmail-from">${escapeHTML(email.from)}</span><span class="gmail-date">${escapeHTML(email.date)}</span></div><div class="gmail-subject">${escapeHTML(email.subject)}</div><div class="gmail-snippet">${escapeHTML(email.snippet)}...</div>`; li.addEventListener('click', () => { window.open(`https://mail.google.com/mail/u/0/#inbox/${email.threadId}`, '_blank'); }); list.appendChild(li); }); }
    function displayGmailError(error) { const list = document.getElementById('gmail-list'); const loading = document.getElementById('gmail-loading'); loading.style.display = 'none'; list.innerHTML = `<li>エラー: ${escapeHTML(error.message)}</li>`; console.error('Gmail Error:', error); }

    init();
});
</script>
